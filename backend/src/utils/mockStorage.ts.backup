/**
 * Mock Storage - Veritabanı bağlantısı olmadığında bakiye gibi 
 * verilerin session boyunca "kalıcı" kalmasını sağlar.
 */

interface MockUserStore {
    [userId: string]: {
        creditBalance: number;
        experienceYears: number;
        specialties: string[];
        fullName?: string;
        phone?: string;
        email?: string;
        isVerified?: boolean;
        profileImageUrl?: string;
        verificationStatus?: string | null;
        documentType?: string;
        submittedAt?: string;
        documentUrl?: string | null;
    }
}

// Singleton storage
const mockStore: MockUserStore = {};

export const mockStorage = {
    get: (userId: string) => {
        if (!mockStore[userId]) {
            // Default initial values
            mockStore[userId] = {
                creditBalance: 0,
                experienceYears: 0,
                specialties: [],
                fullName: '',
                phone: '',
                email: userId.includes('@') ? userId : 'mock@example.com',
                isVerified: false,
                verificationStatus: null
            };
        }
        return mockStore[userId];
    },

    updateProfile: (userId: string, data: {
        experienceYears?: number,
        specialties?: string[],
        fullName?: string,
        phone?: string,
        email?: string,
        isVerified?: boolean,
        profileImageUrl?: string,
        verificationStatus?: string | null,
        documentType?: string,
        submittedAt?: string,
        documentUrl?: string | null
    }) => {
        const store = mockStorage.get(userId);
        if (data.experienceYears !== undefined) store.experienceYears = data.experienceYears;
        if (data.specialties !== undefined) store.specialties = data.specialties;
        if (data.fullName !== undefined) store.fullName = data.fullName;
        if (data.phone !== undefined) store.phone = data.phone;
        if (data.email !== undefined) store.email = data.email;
        if (data.isVerified !== undefined) store.isVerified = data.isVerified;
        if (data.profileImageUrl !== undefined) store.profileImageUrl = data.profileImageUrl;
        if (data.verificationStatus !== undefined) store.verificationStatus = data.verificationStatus;
        if (data.documentType !== undefined) store.documentType = data.documentType;
        if (data.submittedAt !== undefined) store.submittedAt = data.submittedAt;
        if (data.documentUrl !== undefined) store.documentUrl = data.documentUrl;
        return store;
    },

    updateBalance: (userId: string, newBalance: number) => {
        const store = mockStorage.get(userId);
        store.creditBalance = newBalance;
        return store;
    },

    addCredits: (userId: string, amount: number) => {
        const data = mockStorage.get(userId);
        data.creditBalance += amount;
        return data;
    },

    getFullUser: (userId: string, userType: string = 'CITIZEN') => {
        const store = mockStorage.get(userId);
        return {
            id: userId,
            fullName: store.fullName || 'Test Kullanıcısı',
            email: store.email || 'mock@example.com',
            phone: store.phone || '',
            userType: userType,
            profileImageUrl: store.profileImageUrl || null,
            isVerified: store.isVerified || false,
            verificationStatus: store.verificationStatus || null,
            documentType: store.documentType || null,
            submittedAt: store.submittedAt || null,
            electricianProfile: userType === 'ELECTRICIAN' ? {
                experienceYears: store.experienceYears,
                specialties: store.specialties,
                creditBalance: store.creditBalance,
                isAvailable: true,
                verificationStatus: store.verificationStatus || null,
                verificationDocuments: {
                    documentType: store.documentType || null,
                    documentUrl: store.documentUrl || null,
                    submittedAt: store.submittedAt || null,
                }
            } : null
        };
    },

    getAllUsers: () => {
        return Object.keys(mockStore).map(id => {
            // Determine userType from ID suffix if possible, else default
            const userType = id.endsWith('-ADMIN') ? 'ADMIN' : (id.endsWith('-ELECTRICIAN') ? 'ELECTRICIAN' : 'CITIZEN');
            return mockStorage.getFullUser(id, userType);
        });
    }
};
